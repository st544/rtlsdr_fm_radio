name: CI
on: [push, pull_request]

jobs:
  windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Clean build dir
        shell: pwsh
        run: |
          if (Test-Path build) { Remove-Item -Recurse -Force build }

      - name: Setup Ninja
        uses: seanmiddleditch/gha-setup-ninja@v5

      - name: Configure vcpkg binary cache
        shell: pwsh
        run: |
          echo "VCPKG_BINARY_SOURCES=clear;x-gha,readwrite" >> $env:GITHUB_ENV

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgDirectory: '${{ github.workspace }}/vcpkg'
          vcpkgJsonGlob: '**/vcpkg.json'

      - name: Configure
        shell: pwsh
        run: >
          cmake -S . -B build/win-release -G Ninja
          -DCMAKE_BUILD_TYPE=Release
          -DCMAKE_TOOLCHAIN_FILE=${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake
          -DVCPKG_TARGET_TRIPLET=x64-windows

      - name: Setup MSVC dev env
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64
      
      - name: Configure (MSVC)
        shell: pwsh
        run: >
          cmake -S . -B build/win-release
          -G "Visual Studio 17 2022" -A x64
          -DCMAKE_TOOLCHAIN_FILE="${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake"
          -DVCPKG_TARGET_TRIPLET=x64-windows
      
      - name: Build
        shell: pwsh
        run: cmake --build build/win-release --config Release
