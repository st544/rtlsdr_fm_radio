name: CI
on: [push, pull_request]

jobs:
  windows:
    runs-on: windows-latest

    env:
      VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite"
      VCPKG_TARGET_TRIPLET: "x64-windows"

    steps:
      - uses: actions/checkout@v4

      - name: Clean build dir
        shell: pwsh
        run: |
          if (Test-Path build) { Remove-Item -Recurse -Force build }

      # Ensure we compile with MSVC x64 (avoids MinGW picking up g++)
      - name: Setup MSVC dev env
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Sanity check compiler
        shell: pwsh
        run: |
          where cl
          cl /Bv

      # Clone/bootstrap vcpkg and install manifest dependencies (uses your vcpkg.json + builtin-baseline)
      - name: Setup vcpkg (manifest)
        id: vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          # IMPORTANT: keep vcpkg outside the repo; don't treat it as a git submodule
          vcpkgDirectory: "${{ runner.temp }}/vcpkg"
          vcpkgJsonGlob: "**/vcpkg.json"

      # Configure with a CI-safe toolchain path (from run-vcpkg output), not your local C:\Users\... path
      - name: Configure
        shell: pwsh
        run: >
          cmake -S . -B build/win-release
          -G "Visual Studio 17 2022" -A x64
          -DCMAKE_TOOLCHAIN_FILE="${{ steps.vcpkg.outputs.vcpkgRoot }}/scripts/buildsystems/vcpkg.cmake"
          -DVCPKG_TARGET_TRIPLET=${{ env.VCPKG_TARGET_TRIPLET }}

      - name: Build
        shell: pwsh
        run: cmake --build build/win-release --config Release